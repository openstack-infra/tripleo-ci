---
- when: rhel_image_source is defined
  block:
    - name: Set dib_local_image and other facts used by tripleo-ci build-image role build template
      set_fact:
        dib_local_image: "{{ workspace }}/{{ rhel_image_source | urlsplit('path') | basename }}"
        dib_node_dist: "rhel"
        dib_release: "8"
        dib_yum_repo_conf: >-
          /etc/yum.repos.d/delorean.repo
          /etc/yum.repos.d/delorean-rhel8-{{ release|default('master') }}-deps.repo
          /etc/yum.repos.d/rh-cloud.repo
        cacheable: true

    - name: Download rhel source image
      get_url:
        url: "{{ rhel_image_source }}"
        dest: "{{ dib_local_image }}"

# get python_v fact used with vars/common.yaml to get
# python2 or python3 packages in below tasks
- name: Get python_v fact for py2 or py3 common vars
  include_tasks: check_set_py3.yaml

- name: Install pip and virtualenv
  become: true
  package:
    name: "{{ item }}"
    state: present
  loop:
    - "{{ python_version[python_v] }}-pip"
    - "{{ python_version[python_v] }}-virtualenv"

- when: python_v == "py3"
  block:

    - name: Install python3-devel with provides pathfix.py
      package:
        name: python3-devel
        state: present
      become: true

    - name: Create a script that fixes shebang for python3
      template:
        src: pathfix_repos.sh.j2
        dest: "{{ workspace }}/pathfix_repos.sh"
        mode: u=rwx

    - name: Fix shebang path for python3
      shell: bash {{ workspace }}/pathfix_repos.sh

- name: pip install tripleo items
  become: true
  pip:
    name:
      - "file://{{ openstack_git_root }}/diskimage-builder"
      - "file://{{ openstack_git_root }}/python-tripleoclient"
      - "file://{{ openstack_git_root }}/tripleo-common"
    state: present
    virtualenv: "{{ workspace }}/venv"
